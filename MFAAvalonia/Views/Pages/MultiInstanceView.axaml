<UserControl
    d:DesignHeight="600"
    d:DesignWidth="900"
    mc:Ignorable="d"
    x:Class="MFAAvalonia.Views.Pages.MultiInstanceView"
    x:DataType="pages:MultiInstanceViewModel"
    xmlns="https://github.com/avaloniaui"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:helper="clr-namespace:MFAAvalonia.Helper"
    xmlns:markup="https://codewf.com"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:multiInstance="clr-namespace:MFAAvalonia.Models.MultiInstance"
    xmlns:pages="clr-namespace:MFAAvalonia.ViewModels.Pages"
    xmlns:suki="https://github.com/kikipoulet/SukiUI"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml">

    <Design.DataContext>
        <pages:MultiInstanceViewModel />
    </Design.DataContext>

    <Grid Margin="16">
        <Grid.RowDefinitions>
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <!-- ä¸»å†…å®¹åŒº -->
        <Grid Grid.Row="0" ColumnDefinitions="400,*">

            <!-- å·¦ä¾§ï¼šæ¨¡æ‹Ÿå™¨åˆ—è¡¨ -->
            <Border
                Background="{DynamicResource SukiCardBackground}"
                BorderBrush="{DynamicResource SukiBorderBrush}"
                BorderThickness="1"
                CornerRadius="8"
                Margin="0,0,8,0"
                Padding="16">
                <Grid RowDefinitions="Auto,*">

                    <!-- æ¨¡æ‹Ÿå™¨åˆ—è¡¨æ ‡é¢˜å’Œåˆ·æ–°æŒ‰é’® -->
                    <Grid Grid.Row="0" ColumnDefinitions="*,Auto" Margin="0,0,0,12">
                        <TextBlock
                            FontSize="16"
                            FontWeight="SemiBold"
                            Grid.Column="0"
                            Text="æ¨¡æ‹Ÿå™¨åˆ—è¡¨"
                            VerticalAlignment="Center" />
                        <Button
                            Command="{Binding RefreshDevicesCommand}"
                            Content="ðŸ”„ åˆ·æ–°"
                            FontSize="12"
                            Grid.Column="1"
                            Height="28"
                            Padding="8,4" />
                    </Grid>

                    <!-- æ¨¡æ‹Ÿå™¨åˆ—è¡¨ -->
                    <ScrollViewer Grid.Row="1">
                        <ItemsControl ItemsSource="{Binding Accounts}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate DataType="multiInstance:MultiAccount">
                                    <Border
                                        Background="{DynamicResource SukiBackground}"
                                        BorderBrush="{DynamicResource SukiBorderBrush}"
                                        BorderThickness="1"
                                        CornerRadius="6"
                                        Margin="0,0,0,8"
                                        Padding="12">
                                        <Grid RowDefinitions="Auto,Auto">

                                            <!-- ç¬¬ä¸€è¡Œï¼šåç§°ã€é˜Ÿé•¿å·æ ‡ç­¾ã€çŠ¶æ€ä¿¡æ¯å’Œå¯ç”¨å¼€å…³ -->
                                            <Grid ColumnDefinitions="*,Auto,Auto,Auto,Auto" Grid.Row="0">
                                                <TextBlock
                                                    FontSize="15"
                                                    FontWeight="Medium"
                                                    Grid.Column="0"
                                                    Text="{Binding Name}"
                                                    VerticalAlignment="Center" />

                                                <!-- é˜Ÿé•¿å·æ ‡ç­¾ -->
                                                <Border
                                                    Background="{DynamicResource SukiPrimaryColor}"
                                                    CornerRadius="4"
                                                    Grid.Column="1"
                                                    IsVisible="{Binding IsLeader}"
                                                    Margin="0,0,8,0"
                                                    Padding="6,2"
                                                    VerticalAlignment="Center">
                                                    <TextBlock
                                                        FontSize="11"
                                                        FontWeight="Bold"
                                                        Foreground="White"
                                                        Text="é˜Ÿé•¿" />
                                                </Border>

                                                <!-- è®¾ç½®ä¸ºé˜Ÿé•¿å·æŒ‰é’® -->
                                                <Button
                                                    Command="{Binding $parent[ItemsControl].((pages:MultiInstanceViewModel)DataContext).SetLeaderCommand}"
                                                    CommandParameter="{Binding}"
                                                    Content="ðŸ‘‘"
                                                    FontSize="14"
                                                    Grid.Column="1"
                                                    Height="24"
                                                    IsVisible="{Binding !IsLeader}"
                                                    Margin="0,0,8,0"
                                                    Padding="6,0"
                                                    ToolTip.Tip="è®¾ä¸ºé˜Ÿé•¿å·"
                                                    Width="32" />

                                                <!-- çŠ¶æ€å’Œè¿›åº¦ -->
                                                <StackPanel Grid.Column="2" Margin="0,0,8,0" Orientation="Horizontal" Spacing="6" VerticalAlignment="Center">
                                                    <Border
                                                        Background="{Binding StatusColor}"
                                                        CornerRadius="8"
                                                        Height="8"
                                                        VerticalAlignment="Center"
                                                        Width="8" />
                                                    <TextBlock
                                                        FontSize="11"
                                                        Foreground="{Binding StatusColor}"
                                                        Text="{Binding StatusText}"
                                                        VerticalAlignment="Center" />
                                                    <TextBlock
                                                        FontSize="11"
                                                        Foreground="{DynamicResource SukiLowText}"
                                                        Text="{Binding Progress, StringFormat='{}{0}%'}"
                                                        VerticalAlignment="Center" />
                                                </StackPanel>

                                                <ToggleSwitch
                                                    Grid.Column="3"
                                                    IsChecked="{Binding IsEnabled}"
                                                    OffContent=""
                                                    OnContent="" />
                                            </Grid>

                                            <!-- ç¬¬äºŒè¡Œï¼šæ¨¡æ‹Ÿå™¨ä¿¡æ¯ -->
                                            <TextBlock
                                                FontSize="11"
                                                Foreground="{DynamicResource SukiLowText}"
                                                Grid.Row="1"
                                                Margin="0,4,0,0">
                                                <Run Text="æ¨¡æ‹Ÿå™¨ï¼š" />
                                                <Run FontWeight="Medium" Text="{Binding EmulatorType, Mode=OneWay}" />
                                                <Run Text=" - ç´¢å¼•ï¼š" />
                                                <Run FontWeight="Medium" Text="{Binding EmulatorIndex, Mode=OneWay}" />
                                            </TextBlock>

                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </ScrollViewer>

                </Grid>
            </Border>

            <!-- å³ä¾§ï¼šä»»åŠ¡åˆ—è¡¨åŒº -->
            <Border
                Background="{DynamicResource SukiCardBackground}"
                BorderBrush="{DynamicResource SukiBorderBrush}"
                BorderThickness="1"
                CornerRadius="8"
                Grid.Column="1"
                Padding="16">

                <Grid RowDefinitions="Auto,*">

                    <!-- ä»»åŠ¡åˆ—è¡¨æ ‡é¢˜ -->
                    <TextBlock
                        FontSize="16"
                        FontWeight="SemiBold"
                        Grid.Row="0"
                        Margin="0,0,0,12"
                        Text="ä»»åŠ¡åˆ—è¡¨" />

                    <!-- ä»»åŠ¡åˆ—è¡¨ - 3:2åˆ†æ å¸ƒå±€ -->
                    <Grid Grid.Row="1" ColumnDefinitions="3*,2*">

                        <!-- å·¦ä¾§ï¼šå•äººä»»åŠ¡ (60%) -->
                        <Border Grid.Column="0" Padding="0,0,8,0">
                            <ScrollViewer>
                                <StackPanel Spacing="8">
                                    <!-- åˆ†ç±»æ ‡é¢˜å’Œæ“ä½œæŒ‰é’® -->
                                    <Grid ColumnDefinitions="*,Auto,Auto">
                                        <TextBlock
                                            FontSize="14"
                                            FontWeight="SemiBold"
                                            Foreground="{DynamicResource SukiPrimaryColor}"
                                            Grid.Column="0"
                                            Text="å•äººä»»åŠ¡"
                                            VerticalAlignment="Center" />
                                        <Button
                                            Command="{Binding SelectAllSoloTasksCommand}"
                                            Content="å…¨é€‰"
                                            FontSize="11"
                                            Grid.Column="1"
                                            Height="24"
                                            Margin="0,0,4,0"
                                            Padding="8,2" />
                                        <Button
                                            Command="{Binding DeselectAllSoloTasksCommand}"
                                            Content="å–æ¶ˆ"
                                            FontSize="11"
                                            Grid.Column="2"
                                            Height="24"
                                            Padding="8,2" />
                                    </Grid>

                                    <!-- å•äººä»»åŠ¡åˆ—è¡¨ -->
                                    <ItemsControl ItemsSource="{Binding SoloTasks}">
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate DataType="multiInstance:MultiTaskItem">
                                                <CheckBox IsChecked="{Binding IsChecked}" Margin="0,0,0,6">
                                                    <StackPanel Orientation="Horizontal" Spacing="6">
                                                        <!-- ä»»åŠ¡å›¾æ ‡ -->
                                                        <Image
                                                            Height="16"
                                                            IsVisible="{Binding HasIcon}"
                                                            Source="{Binding ResolvedIcon}"
                                                            VerticalAlignment="Center"
                                                            Width="16" />

                                                        <!-- ä»»åŠ¡åç§°å’Œæè¿° -->
                                                        <StackPanel>
                                                            <TextBlock FontWeight="Medium" Text="{Binding DisplayName}" />
                                                            <TextBlock
                                                                FontSize="11"
                                                                Foreground="{DynamicResource SukiLowText}"
                                                                IsVisible="{Binding Description, Converter={x:Static ObjectConverters.IsNotNull}}"
                                                                Text="{Binding Description}"
                                                                TextWrapping="Wrap" />
                                                        </StackPanel>
                                                    </StackPanel>
                                                </CheckBox>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                </StackPanel>
                            </ScrollViewer>
                        </Border>

                        <!-- å³ä¾§ï¼šç»„é˜Ÿä»»åŠ¡ (40%) -->
                        <Border Grid.Column="1" Padding="8,0,0,0">
                            <ScrollViewer>
                                <StackPanel Spacing="8">
                                    <!-- åˆ†ç±»æ ‡é¢˜å’Œæ“ä½œæŒ‰é’® -->
                                    <Grid ColumnDefinitions="*,Auto,Auto">
                                        <TextBlock
                                            FontSize="14"
                                            FontWeight="SemiBold"
                                            Foreground="{DynamicResource SukiPrimaryColor}"
                                            Grid.Column="0"
                                            Text="ç»„é˜Ÿä»»åŠ¡"
                                            VerticalAlignment="Center" />
                                        <Button
                                            Command="{Binding SelectAllTeamTasksCommand}"
                                            Content="å…¨é€‰"
                                            FontSize="11"
                                            Grid.Column="1"
                                            Height="24"
                                            Margin="0,0,4,0"
                                            Padding="8,2" />
                                        <Button
                                            Command="{Binding DeselectAllTeamTasksCommand}"
                                            Content="å–æ¶ˆ"
                                            FontSize="11"
                                            Grid.Column="2"
                                            Height="24"
                                            Padding="8,2" />
                                    </Grid>

                                    <!-- ç»„é˜Ÿä»»åŠ¡åˆ—è¡¨ -->
                                    <ItemsControl ItemsSource="{Binding TeamTasks}">
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate DataType="multiInstance:MultiTaskItem">
                                                <CheckBox IsChecked="{Binding IsChecked}" Margin="0,0,0,6">
                                                    <StackPanel Orientation="Horizontal" Spacing="6">
                                                        <!-- ä»»åŠ¡å›¾æ ‡ -->
                                                        <Image
                                                            Height="16"
                                                            IsVisible="{Binding HasIcon}"
                                                            Source="{Binding ResolvedIcon}"
                                                            VerticalAlignment="Center"
                                                            Width="16" />

                                                        <!-- ä»»åŠ¡åç§°å’Œæè¿° -->
                                                        <StackPanel>
                                                            <TextBlock FontWeight="Medium" Text="{Binding DisplayName}" />
                                                            <TextBlock
                                                                FontSize="11"
                                                                Foreground="{DynamicResource SukiLowText}"
                                                                IsVisible="{Binding Description, Converter={x:Static ObjectConverters.IsNotNull}}"
                                                                Text="{Binding Description}"
                                                                TextWrapping="Wrap" />
                                                        </StackPanel>
                                                    </StackPanel>
                                                </CheckBox>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                </StackPanel>
                            </ScrollViewer>
                        </Border>

                    </Grid>

                </Grid>

            </Border>

        </Grid>

        <!-- åº•éƒ¨ï¼šæ‰§è¡ŒæŽ§åˆ¶åŒº -->
        <Border
            Background="{DynamicResource SukiCardBackground}"
            BorderBrush="{DynamicResource SukiBorderBrush}"
            BorderThickness="1"
            CornerRadius="8"
            Grid.Row="1"
            Margin="0,8,0,0"
            Padding="16">

            <Grid RowDefinitions="Auto,Auto">

                <!-- æ‰§è¡ŒçŠ¶æ€ -->
                <StackPanel Grid.Row="0" Margin="0,0,0,12" Spacing="6">
                    <TextBlock FontSize="13" FontWeight="Medium" Text="å¯ç”¨çŠ¶æ€" />
                    <TextBlock FontSize="12" Foreground="{DynamicResource SukiLowText}">
                        <Run Text="å·²å¯ç”¨ï¼š" />
                        <Run
                            FontWeight="Bold"
                            Foreground="{DynamicResource SukiPrimaryColor}"
                            Text="{Binding EnabledAccountCount, Mode=OneWay}" />
                        <Run Text=" / 5 " />
                        <Run Text=" | é˜Ÿé•¿å·ï¼š" />
                        <Run
                            FontWeight="Bold"
                            Foreground="{DynamicResource SukiPrimaryColor}"
                            Text="{Binding LeaderAccountName, Mode=OneWay}" />
                    </TextBlock>
                </StackPanel>

                <!-- æŽ§åˆ¶æŒ‰é’® -->
                <UniformGrid Columns="4" Grid.Row="1">
                    <Button
                        Classes="Accent"
                        Command="{Binding StartAllCommand}"
                        Content="â–¶ å¼€å§‹æ‰§è¡Œ"
                        IsEnabled="{Binding !IsRunning}"
                        Margin="0,0,4,0" />
                    <Button
                        Command="{Binding StopAllCommand}"
                        Content="â¹ åœæ­¢å…¨éƒ¨"
                        IsEnabled="{Binding IsRunning}"
                        Margin="2,0" />
                    <Button
                        Command="{Binding ResetAllCommand}"
                        Content="ðŸ”„ é‡ç½®çŠ¶æ€"
                        IsEnabled="{Binding !IsRunning}"
                        Margin="2,0" />
                    <Button
                        Content="ðŸ“‹ æŸ¥çœ‹æ—¥å¿—"
                        IsEnabled="False"
                        Margin="4,0,0,0"
                        ToolTip.Tip="å³å°†æ”¯æŒ" />
                </UniformGrid>

            </Grid>

        </Border>

    </Grid>

</UserControl>
